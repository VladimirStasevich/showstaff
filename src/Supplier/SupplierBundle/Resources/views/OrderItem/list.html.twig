{% extends 'SupplierBundle::base.html.twig' %}

{% block body %}

	<div  class="row">
		<div class="span12">
			<div class="row-fluid">
				<div class="span9">
					<h1>Компания "{{ company.name }}"</h1>
					<h2>Продукты для ресторана "{{ restaurant.name }}" на {{ booking_date }}</h2>
					{% if edit_mode == false %}<p class="alert">Заказ закрыт для редактирования</p>{% endif %}
				</div>
				<div class="span3">
					<form class=" pull-right form-inline">
						<input type="text" value="{{ booking_date }}" class="datepicker input-small">
						<a href="" class="btn" id="link_to_date">Открыть</a>
					</form>
				</div>
			</div>
			<table class="table table-bordered table-striped" id="bookin_list">
			 <thead>
			  <tr>
				<th>Название
					<a href="#" class="sort sort_by_name"><i class="icon-arrow-up"></i></a>
				</th>
				<th>Количество
					<a href="#" class="sort sort_by_amount"><i class="icon-arrow-up"></i></a>
				</th>
				<th></th>
			  </tr>
			{% if edit_mode %}
			  <tr id="add_row">
				<th colspan="3" class="add">
					<a href="#" class="create btn btn-small">Заказать продукт <i class="icon-plus-sign"></i></a>
					<p class="form-inline hide" id="form_add">
                        <select class="product_add"></select>
						<input name="amount_add" type="text" placeholder="Amount" class="input-large amount_add">
						<button class="add_booking btn btn-mini btn-success">add</button>
					</p>
				</th>
			  </tr>
			{% endif %}
			 </thead>
			</table>
			<script src="/js/booking.js"></script>
			<script type="text/javascript">
			
				{% if edit_mode %}
					var edit_mode = true;
				{% else %}
					var edit_mode = false;
				{% endif %}
			
				var products = new Backbone.Collection;
				products.reset({{ products_json|raw }});
				
				// Collection bookings
				var ContentBooking = Backbone.Collection.extend({
				  
				  model: BookingModel,
				  
				  url: '/company/{{ company.id }}/restaurant/{{ restaurant.id }}/order/{{ booking_date }}',
				  
				  initialize: function(){
					  this.bind('add', this.addBooking);
				  },
				  
				  addBooking: function(product){
					product.save({wait: true});
				  },
				  
				});
				
				var bookings = new ContentBooking; // init collection

				var view_content = new ViewBookings({collection: bookings}); // initialize view


				bookings.comparator = function(booking) {
				  return booking.get("name");
				};

				$('#bookin_list').append(view_content.render().el); // add template
				
				if (edit_mode) {
					$('#preloader').width($('#add_row').width());
					$('#preloader').height($('#add_row').height());
					var p = $('#add_row').position();
					$('#preloader').css({'left':p.left, 'top': p.top});
					$('#preloader').fadeIn('fast');
				}
				
				bookings.reset({{ bookings_json|raw }});
			
				if (products.length == 0) {
					$('#bookin_list').append('<tr class="alert_row"><td colspan="3"><div class="alert">'+
												'<button type="button" class="close" data-dismiss="alert">×</button>'+
												'У вас нет доступных продуктов для заказа</div></td></tr>');
				}
			
				if (!edit_mode) {
					$('#bookin_list .remove').remove();
				}
				
			</script>
		</div>
	</div>
{% endblock %}

